# Modbus 通信协议介绍

Modbus是一种通信协议，由莫迪康（Modicon，现施耐德电气 Schneider Electric）公司于1979年发布，旨在为可编程逻辑控制通信提供标准。Modbus是为了解决PLC控制器之间通信的问题。

Modbus 协议特点：

- 免费、开放、无版权要求
- 报文（协议消息帧）格式简单紧凑，通俗易懂，厂商容易集成
- 不仅可以使用在串口通信，比如RS232、RS485、RS422，还可以用于以太网、光纤、蓝牙、无线等多种通信介质。

Modbus协议是一种应用层报文传输协议，包括ASCII、RTU、TCP三种报文类型。

Modbus报文帧分为：

- RTU
- ASCII
- TCP

通信介质：

- 串口：串口通信的接口标准有RS232（扫码枪、仪表）、RS485（PLC、仪表）、RS422（不常用）
- 以太网：TCP、UDP

**串口传输通常选择RTU或ASCII模式；以太网传输一般使用TCP模式**。

根据不同报文帧和通信介质分为以下通信协议：

- ==ModbusRTU==：RTU报文帧+串口（常用）
- ModbusRTUOverTCP：RTU报文帧 + TCP
- ModbusRTUOverUDP：RTU报文帧 + UDP
- ModbusASCII：ASCII报文帧 + 串口
- ModbusASCIIOverTCP：ASCII报文帧 + TCP
- ModbusASCIIOverUDP：ASCII报文帧 + UDP
- ==ModbusTCP==：TCP报文帧 + TCP（常用）
- ModbusUDP：TCP报文帧 + UDP

由于不够安全，TCP报文帧几乎很少通过串口通信，而是通过以太网。



## Modbus 存储区和功能码

### 存储区

Modbus协议主要用于实现不同设备间的数据交互和通信，为了管理数据，引入了存储区的概念。类似于可编程逻辑控制器（PLC）中的存储区。

不同品牌的PLC定义了各自特有的存储区，比如：

- 西门子PLC：定义了M、Q、V、DB存储区
- 三菱PLC：定义了X、Y、M、D、W存储区

#### 存储区的分类

Modbus协议的存储区根据数据类型分为：

- 布尔类型：用于存储布尔变量，被称为**线圈**。
- 字类型：用于存储一般数据，被称为**寄存器**。

根据存储区的读写特性，存储区分为：

- 只读类型：只读存储区仅允许读取数据，不能写入，在Modbus协议中，只读存储区被称为**输入**。
- 可读可写类型：可读可写存储区允许读取和写入数据，在Modbus协议中，可读可写存储区被称为**输出**。

由此根据数据类型和读写特性，Modbus协议规定了四种类型存储区：

| 存储区名称                 | 数据类型  | 读写特性 | 存储区代号 |
| -------------------------- | --------- | -------- | ---------- |
| 输出线圈                   | 布尔/线圈 | 可读可写 | 0区        |
| 输入线圈                   | 布尔/线圈 | 只读     | 1区        |
| 输入寄存器                 | 字/寄存器 | 只读     | 3区        |
| 输出寄存器（保持型寄存器） | 字/寄存器 | 可读可写 | 4区        |

- 输出寄存器在Modbus协议规范中一般称为**保持型寄存器**。
- 根据Modbus协议的规定，每个存储区都有一个特定的代号，用数字形式表示，注意没有2区。

注意：这里的输入和输出不是字面意思“输入”和“输出”，而是应该理解为只读和可读写。

### 功能码

上述四个存储区，根据读取和写入操作，组合出下述几种行为：

- 读取输入线圈
- 读取输出线圈
- 读取输入寄存器
- 读取输出寄存器（读取保持型寄存器）
- 写入输出线圈
  - 写入单个线圈
  - 写入多个线圈
- 写入输出寄存器
  - 写入单个寄存器
  - 写入多个寄存器

注意：输入线圈和输入寄存器是只读的，不能进行写入，因此可以进行写入操作的存储区只有输出线圈和输出寄存器。而写入方式有单个写入和多个写入。因此写入操作最终分为四种行为，即写入单个线圈，写入多个线圈，写入单个寄存器，写入多个寄存器。

以上8中行为编号，形成Modbus的8大功能码：

| 功能码    | 说明                                   |
| --------- | -------------------------------------- |
| 0x 01     | 读取输出线圈                           |
| 0x 02     | 读取输入线圈                           |
| 0x 03     | **读取保持型寄存器**（读取输出寄存器） |
| 0x 04     | 读取输入寄存器                         |
| 0x 05     | 写入单个线圈                           |
| 0x 06     | 写入单个寄存器                         |
| ==0x 0F== | 写入**多个**线圈                       |
| ==0x 10== | 写入**多个**寄存器                     |

注意：上述中的输入和输出，非字面意思的“输入”和“输出”，而是应当作“只读”和“可读可写”来代替。

由于功能码是在存储区的基础上衍生而来的，因此只要知道功能码，就可以定位到具体的存储区。例如功能码为0x10，表示写入多个寄存器，对应的存储区为输出寄存器（保持型寄存器），即4区。

#### 异常功能码

异常功能码通常以8开头，如0x81，0x83等，用来表示不同类型的通信异常情况。

异常功能码与正常功能码之间的关系为：

异常功能码 = 正常功能码 + 0x80



## ModbusRTU 通信协议

Modbus 协议在**串口通信**介质中有两种主要的通信协议格式：Modbus RTU和Modbus ASCII，它们发送报文数据的格式几乎一样。

Modbus有8大功能码，当需要读取不同功能码的数据时，需要客户端先发送对应功能码的报文，服务端处理完后，客户端再读取接收到的报文数据。

不同功能码发送和接收的报文格式，见书中描述。

### 串口通信的接口标准

- RS232：只能一对一
- RS485
- RS422

![image-20250723174609566](./assets/image-20250723174609566.png)









## ModbusTCP/UDP 通信协议











## 一主多从原理

主站：主动发送指令的终端，类似于浏览器，如上位机。

从站：被动提供数据的终端，类似于服务器，如仪表。

PLC既可以做主站也可以做从站。

  一主多从：从站地址不允许重复。实现一主多从的前提：

- 接口标准要支持，RS-232不能实现。
- 协议报文要支持。

### 接线方法

正确的接线方式，采用“手拉手接线”方法：

![image-20250723175028712](./assets/image-20250723175028712.png)

“星型接法”是错误的接线方式：

![image-20250723175134115](./assets/image-20250723175134115.png)

这种方式很容易造成信号反射导致总线不稳定。虽然有的时候整个系统不出问题，但是有的时候则总是出现问题，又很难查找原因，建议在布线时就采用手拉手连接方式，便于后期问题排查。

串口的速度，取决于波特率，波特率越大，速度越块。

串口的读取，是使用线程循环取值。





